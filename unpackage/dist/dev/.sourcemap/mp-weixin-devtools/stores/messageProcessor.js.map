{"version":3,"names":["useMessageProcessorStore","common_vendor","defineStore","barrageStore","stores_barrage","useBarrageStore","stores_audioPlayer","useAudioPlayerStore","isStreaming","ref","accumulatedText","processMessage","data","JSON","parse","e","index","__f__","showTextMessage","cmd","handleBgMusic","handleTtsAudio","handleFinishMessage","handleSubjectRequest","handleErrorMessage","text","msg","audio_url","section_id","audio_id","value","appendToStreamingMessage","full_text","finishStreamingMessage","subjects","join","addMessage","type","content","showToast","title","icon","duration","arguments","length","undefined"],"sources":["messageProcessor.js"],"sourcesContent":["// stores/messageProcessor.js\nimport { defineStore } from 'pinia'\nimport { useBarrageStore } from './barrage'\nimport { useAudioPlayerStore } from './audioPlayer'\n\nexport const useMessageProcessorStore = defineStore('messageProcessor', () => {\n  const barrageStore = useBarrageStore()\n  const audioPlayerStore = useAudioPlayerStore()\n\n  // å¤„ç†æŽ¥æ”¶åˆ°çš„æµå¼æ¶ˆæ¯\n  const isStreaming = ref(false)\n  const accumulatedText = ref('')\n\n  // å¤„ç†æŽ¥æ”¶åˆ°çš„æ¶ˆæ¯\n  const processMessage = (data) => {\n    // å¦‚æžœæ˜¯å­—ç¬¦ä¸²ï¼Œå…ˆå°è¯•è§£æžä¸ºJSON\n    if (typeof data === 'string') {\n      try {\n        data = JSON.parse(data)\n      } catch (e) {\n        console.error('æ¶ˆæ¯è§£æžå¤±è´¥', e)\n        // ä½œä¸ºçº¯æ–‡æœ¬æ¶ˆæ¯å¤„ç†\n        showTextMessage(data)\n        return\n      }\n    }\n\n    // æ ¹æ®cmdç±»åž‹å¤„ç†ä¸åŒæ¶ˆæ¯\n    switch (data.cmd) {\n      case 'bg_music':\n        handleBgMusic(data)\n        break\n      case 'audio':\n        handleTtsAudio(data)\n        break\n      case 'finish':\n        handleFinishMessage(data)\n        break\n      case 'subject':\n        handleSubjectRequest(data)\n        break\n      case 'error':\n        handleErrorMessage(data)\n        break\n      default:\n        // æœªçŸ¥æ¶ˆæ¯ç±»åž‹ï¼Œå°è¯•ä½œä¸ºæ–‡æœ¬æ˜¾ç¤º\n        console.warn('æœªçŸ¥æ¶ˆæ¯ç±»åž‹', data)\n        if (data.text || data.msg) {\n          showTextMessage(data.msg)\n        }\n    }\n  }\n\n  // å¤„ç†èƒŒæ™¯éŸ³ä¹æ¶ˆæ¯\n  const handleBgMusic = (data) => {\n    console.log('æ”¶åˆ°èƒŒæ™¯éŸ³ä¹æ¶ˆæ¯', data)\n    // const { audio_url, play_time, section_id } = data\n\n    // // æ’­æ”¾èƒŒæ™¯éŸ³ä¹\n    // audioPlayerStore.playBgMusic(audio_url, play_time || 0)\n\n    // // å¯ä»¥é€‰æ‹©æ˜¯å¦åœ¨å¯¹è¯ç•Œé¢æ˜¾ç¤ºéŸ³ä¹æ’­æ”¾ä¿¡æ¯\n    // barrageStore.addMessage({\n    //   type: 'system',\n    //   content: 'ðŸŽµ èƒŒæ™¯éŸ³ä¹æ’­æ”¾ä¸­...',\n    //   showInUI: false, // å¦‚æžœä¸æƒ³åœ¨ç•Œé¢æ˜¾ç¤ºï¼Œå¯ä»¥è®¾ç½®æ ‡è®°\n    // })\n  }\n\n  // å¤„ç†TTSéŸ³é¢‘æ¶ˆæ¯\n  const handleTtsAudio = (data) => {\n    console.log('æ”¶åˆ°TTSéŸ³é¢‘æ¶ˆæ¯', data)\n    const { audio_url, section_id, audio_id, text } = data\n\n    // å¤„ç†æ–‡æœ¬éƒ¨åˆ† - æµå¼æ–‡æœ¬ç´¯ç§¯\n    if (text) {\n      if (!isStreaming.value) {\n        // ç¬¬ä¸€æ¬¡æ”¶åˆ°éŸ³é¢‘æ–‡æœ¬ï¼Œæ ‡è®°å¼€å§‹æµå¼å“åº”\n        isStreaming.value = true\n        accumulatedText.value = text\n\n        // åœ¨å¯¹è¯æ¡†ä¸­åˆ›å»ºæ–°æ¶ˆæ¯æˆ–è¿½åŠ åˆ°çŽ°æœ‰æµå¼æ¶ˆæ¯\n        barrageStore.appendToStreamingMessage(text)\n      } else {\n        // å·²ç»åœ¨æµå¼å“åº”ä¸­ï¼Œç»§ç»­ç´¯ç§¯æ–‡æœ¬\n        accumulatedText.value += text\n\n        // è¿½åŠ åˆ°å½“å‰æµå¼æ¶ˆæ¯\n        barrageStore.appendToStreamingMessage(text)\n      }\n    }\n\n    // // æ’­æ”¾TTSéŸ³é¢‘\n    // audioPlayerStore.playTtsAudio(audio_url, section_id, audio_id)\n\n    // // å¯ä»¥é€‰æ‹©æ˜¯å¦åœ¨ç•Œé¢æ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾ä¿¡æ¯\n    // barrageStore.addMessage({\n    //   type: 'ai',\n    //   content: 'ðŸ”Š è¯­éŸ³å›žå¤ä¸­...',\n    //   audioUrl: audio_url,\n    //   isAudio: true,\n    // })\n  }\n\n  // å¤„ç†ç»“æŸæ¶ˆæ¯\n  const handleFinishMessage = (data) => {\n    console.log('æ”¶åˆ°ç»“æŸæ¶ˆæ¯', data)\n    const { full_text } = data\n\n    // å¦‚æžœæœ‰full_textï¼Œç”¨å®ƒæ›¿æ¢ç´¯ç§¯çš„æ–‡æœ¬\n    if (full_text) {\n      accumulatedText.value = full_text\n    }\n\n    // ç»“æŸæµå¼æ¶ˆæ¯ï¼Œä½¿ç”¨ç´¯ç§¯çš„æ–‡æœ¬æˆ–full_text\n    barrageStore.finishStreamingMessage(full_text || accumulatedText.value)\n\n    // é‡ç½®æµå¼çŠ¶æ€\n    isStreaming.value = false\n    accumulatedText.value = ''\n  }\n\n  // å¤„ç†ä¸»é¢˜é€‰æ‹©è¯·æ±‚\n  const handleSubjectRequest = (data) => {\n    console.log('æ”¶åˆ°ä¸»é¢˜é€‰æ‹©è¯·æ±‚', data)\n    const subjects = data.subjects.join('\\n')\n    console.log('å¯é€‰ä¸»é¢˜åˆ—è¡¨', subjects)\n    // æ˜¾ç¤ºå¯é€‰ä¸»é¢˜åˆ—è¡¨\n    barrageStore.addMessage({\n      type: 'subject',\n      content: data.msg + '\\n' + subjects,\n    })\n  }\n\n  // å¤„ç†é”™è¯¯æ¶ˆæ¯\n  const handleErrorMessage = (data) => {\n    console.log('æ”¶åˆ°é”™è¯¯æ¶ˆæ¯', data)\n    const { text } = data\n\n    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯\n    uni.showToast({\n      title: text || 'ç³»ç»Ÿé”™è¯¯',\n      icon: 'none',\n      duration: 2000,\n    })\n\n    // åŒæ—¶åœ¨å¯¹è¯ç•Œé¢æ˜¾ç¤º\n    barrageStore.addMessage({\n      type: 'error',\n      content: text || 'ç³»ç»Ÿé”™è¯¯',\n    })\n  }\n\n  // é€šç”¨æ˜¾ç¤ºæ–‡æœ¬æ¶ˆæ¯\n  const showTextMessage = (text, type = 'ai') => {\n    if (!text) return\n\n    barrageStore.addMessage({\n      type: type,\n      content: text,\n    })\n  }\n\n  return {\n    processMessage,\n  }\n})\n"],"mappings":"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","ignoreList":[]}