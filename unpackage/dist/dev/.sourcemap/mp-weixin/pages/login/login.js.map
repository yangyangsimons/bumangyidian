{"version":3,"file":"login.js","sources":["pages/login/login.vue","pages/login/login.vue?type=page"],"sourcesContent":["<template>\n  <view class=\"login-container\">\n    <view class=\"login-bg\">\n      <image\n        src=\"../../static/login-bg.png\"\n        class=\"login-image\"\n        mode=\"aspectFill\"\n      />\n    </view>\n    <view class=\"header\">\n      <view class=\"logo-container\">\n        <image class=\"logo\" src=\"../../static/logo.png\" />\n      </view>\n      <image src=\"../../static/logo-title.png\" class=\"title\">不芒一点</image>\n      <view class=\"describe\"> <text>为你世界加一点</text> </view>\n    </view>\n    <view class=\"main\">\n      <button v-if=\"!agreeProtocol\" class=\"wx-login\" @click=\"clickBtn\">\n        <image class=\"wechat-icon\" src=\"../../static/wechat.png\" />\n        <text class=\"wechat-text\">手机号登录</text>\n      </button>\n      <button\n        v-else\n        class=\"wechat\"\n        open-type=\"getPhoneNumber\"\n        @getphonenumber=\"handleWechatLogin\"\n      >\n        <image class=\"wechat-icon\" src=\"../../static/wechat.png\" />\n        <text class=\"wechat-text\">手机号登录</text>\n      </button>\n      <view class=\"skip\" @click=\"unLoginTry\">\n        <text>不登录，跳过</text>\n        <image\n          class=\"skip-icon\"\n          src=\"../../static/skip.png\"\n          mode=\"scaleToFill\"\n        />\n      </view>\n    </view>\n    <view class=\"footer\">\n      <view class=\"radio-wrapper\" @click=\"agreeProtocol = !agreeProtocol\">\n        <radio\n          :checked=\"agreeProtocol\"\n          class=\"agreement-checkbox\"\n          :color=\"'#A7EE27'\"\n          :checked-color=\"'#A7EE27'\"\n          style=\"transform: scale(0.55)\"\n          catchclick=\"return\"\n        />\n      </view>\n      <text class=\"agreement\">\n        <text class=\"agreement-text\">我已阅读同意不芒一点</text>\n        <text class=\"agreement-link\" @click=\"openAgreement('user')\"\n          >《用户协议》</text\n        >\n        <text class=\"agreement-text\">和</text>\n        <text class=\"agreement-link\" @click=\"openAgreement('privacy')\"\n          >《隐私政策》</text\n        >\n      </text>\n    </view>\n  </view>\n</template>\n\n<script setup>\n  import { ref } from 'vue'\n  import { baseUrl } from '../../utils/config'\n  import { useUserStore } from '@/stores/user'\n  import { storeToRefs } from 'pinia'\n  import request from '@/utils/request'\n  const userStore = useUserStore()\n  const { isLoggedIn } = storeToRefs(userStore)\n  const agreeProtocol = ref(false) // 协议同意状态\n\n  // 微信登录和手机号的处理\n  const unLoginTry = async () => {\n    console.log('游客身份体验')\n    //游客身份体验\n    uni.setStorage({\n      key: 'tourist',\n      data: true,\n      success: (result) => {\n        console.log('游客身份存储成功:', result)\n      },\n    })\n    //新手引导页设置token\n    uni.setStorage({\n      key: 'isFirst',\n      data: true,\n      success: (result) => {\n        console.log('首次使用存储成功:', result)\n        uni.reLaunch({\n          url: '/pages/index/index',\n        })\n      },\n      fail: (error) => {\n        console.log('首次使用存储失败:', error)\n        uni.showToast({\n          title: '游客身份体验失败',\n          icon: 'none',\n        })\n      },\n    })\n  }\n  const token = ref('')\n  // 处理协议/隐私政策点击\n  const openAgreement = (type) => {\n    // 根据类型确定跳转的URL\n    const url =\n      type === 'user'\n        ? '/pages/agreement/agreement?type=user'\n        : '/pages/agreement/agreement?type=privacy'\n\n    // 跳转到协议展示页面\n    uni.navigateTo({ url })\n  }\n  const clickBtn = () => {\n    console.log('点击了微信登录按钮')\n    if (!agreeProtocol.value) {\n      return uni.showToast({\n        title: '请先阅读并同意协议',\n        icon: 'none',\n      })\n    }\n  }\n  const handleWechatLogin = async (e) => {\n    const phoneCode = e.detail.code\n    if (phoneCode === undefined) {\n      return uni.showToast({\n        title: '获取手机号登录',\n        icon: 'none',\n      })\n    }\n    console.log('获取到的手机号code', phoneCode)\n    if (!agreeProtocol.value) {\n      return uni.showToast({\n        title: '请先阅读并同意协议',\n        icon: 'none',\n      })\n    }\n\n    // 微信登录\n    try {\n      // 显示加载中\n      // uni.showLoading({ title: '登录中...', mask: true })\n      const loginRes = await wx.login()\n      console.log('登录返回', loginRes.code)\n      const serverRes = await request(`${baseUrl}/user/code2token`, 'POST', {\n        code: loginRes.code,\n      })\n      console.log('服务器返回', serverRes)\n      // 存储token和用户信息\n      // userStore.setUserInfo(data.userInfo)\n      token.value = serverRes.data.token\n      userStore.setToken(serverRes.token)\n      console.log('登录成功', serverRes.data)\n      console.log('token', serverRes.data.token)\n\n      uni.setStorage({\n        key: 'token',\n        data: serverRes.data.token,\n        success: (result) => {\n          console.log('token存储成功', result)\n          //查看用户是否已经注册过\n        },\n        fail: (error) => {\n          console.log('token存储失败', error)\n        },\n      })\n\n      //判断用户是否已经注册\n      const registerResult = await uni.request({\n        url: 'https://mang.5gradio.com.cn:443/user/user_info',\n        header: {\n          'Content-Type': 'application/json',\n          Authorization: `Bearer ${token.value}`,\n        },\n        method: 'GET',\n      })\n      console.log('获取用户注册信息', registerResult)\n      if (registerResult.data.code === 0 && registerResult.data.data.birth) {\n        console.log('用户已注册生日是：', registerResult.data.data.birth)\n        uni.reLaunch({\n          url: '/pages/index/index',\n        })\n      } else {\n        // 用户未注册走注册流程\n        if (phoneCode) {\n          console.log('获取到的手机号code', e.detail.code)\n          await uni.request({\n            url: `${baseUrl}/user/update_phone`,\n            method: 'POST',\n            header: {\n              'Content-Type': 'application/json',\n              Authorization: `Bearer ${serverRes.data.token}`,\n            },\n            data: {\n              code: phoneCode,\n            },\n          })\n          // await request(`${baseUrl}/user/update_phone`, 'POST', {\n          //   code: e.detail.code,\n          // })\n          uni.reLaunch({ url: '/pages/hello/hello' })\n        } else {\n          console.log('获取手机号失败', e.detail.errMsg)\n          return uni.showToast({\n            title: '获取手机号失败',\n            icon: 'none',\n            duration: 2000,\n          })\n        }\n      }\n    } catch (error) {\n      console.log('error', error)\n      uni.showToast({\n        title: '登录失败',\n        icon: 'none',\n      })\n    } finally {\n      uni.hideLoading()\n    }\n  }\n</script>\n\n<style lang=\"scss\" scoped>\n  .login-container {\n    position: fixed;\n    width: 100%;\n    height: 100%;\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: space-between;\n    .login-bg {\n      width: 100%;\n      height: 100%;\n      position: absolute;\n      top: 0;\n      left: 0;\n      .login-image {\n        width: 100%;\n        height: 100%;\n      }\n    }\n    .header {\n      // border: 1px solid red;\n      position: absolute;\n      top: 456rpx;\n      left: 50%;\n      transform: translateX(-50%);\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: space-between;\n      width: 350rpx;\n      height: 306rpx;\n      .logo-container {\n        width: 142rpx;\n        height: 142rpx;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        border-radius: 42rpx;\n        background: rgba(255, 255, 255, 1);\n        .logo {\n          width: 72rpx;\n          height: 96rpx;\n          // border-radius: 42rpx;\n        }\n      }\n\n      .title {\n        width: 170rpx;\n        height: 40rpx;\n      }\n      .describe {\n        // border: 1px solid red;\n        margin: 0 auto;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        text-align: right;\n        font-size: 24rpx;\n        font-weight: 300;\n        color: rgba(0, 0, 0, 1);\n        letter-spacing: 21rpx;\n        text {\n          margin-left: 21rpx;\n        }\n      }\n    }\n    .main {\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      width: 686rpx;\n      height: 220rpx;\n      position: absolute;\n      bottom: 200rpx;\n      font-size: 28rpx;\n      font-weight: 700;\n      wx-button {\n        border: none;\n      }\n      wx-button:after {\n        display: none;\n      }\n      .wechat {\n        width: 686rpx;\n        height: 90rpx;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        border-radius: 42rpx;\n        background: linear-gradient(\n          233.19deg,\n          rgba(211, 248, 79, 1) 0%,\n          rgba(167, 238, 39, 1) 100%\n        );\n        .wechat-text {\n          font-size: 28rpx;\n          font-weight: 700;\n          color: rgba(26, 28, 30, 1);\n        }\n      }\n      .wx-login {\n        width: 686rpx;\n        height: 90rpx;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        border-radius: 42rpx;\n        background: linear-gradient(\n          233.19deg,\n          rgba(211, 248, 79, 1) 0%,\n          rgba(167, 238, 39, 1) 100%\n        );\n        .wechat-text {\n          font-size: 28rpx;\n          font-weight: 700;\n          color: rgba(26, 28, 30, 1);\n        }\n      }\n      .phone {\n        width: 100%;\n        height: 90rpx;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        border-radius: 42rpx;\n        background: rgba(26, 28, 30, 1);\n        color: rgba(167, 238, 39, 1);\n        font-size: 28rpx;\n        font-weight: 700;\n      }\n      image {\n        width: 28rpx;\n        height: 29rpx;\n        margin-right: 8rpx;\n        margin-bottom: 3rpx;\n      }\n      .skip {\n        width: 300rpx;\n        // border: 1px solid red;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        text-align: center;\n        font-size: 28rpx;\n        letter-spacing: 3rpx;\n        color: rgba(26, 28, 30, 0.75);\n        margin-top: 34rpx;\n        .skip-icon {\n          width: 12rpx;\n          height: 20rpx;\n          margin-left: 15rpx;\n        }\n      }\n    }\n    .footer {\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      width: 710rpx;\n      position: absolute;\n      bottom: 140rpx;\n      font-size: 28rpx;\n      color: rgba(152, 153, 153, 1);\n      font-weight: 400;\n      .radio-wrapper {\n        padding: 10rpx; /* 扩大点击区域 */\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n      .agreement-checkbox {\n        width: 20rpx;\n        height: 20rpx;\n        border-radius: 50%;\n        margin-right: 20rpx;\n        display: flex;\n      }\n      .agreement-link {\n        color: rgba(167, 238, 39, 1);\n      }\n    }\n  }\n</style>\n","import MiniProgramPage from '/Users/lynnyang/work/project/xjlab/HBuilderProjects/bumangyidian/pages/login/login.vue'\nwx.createPage(MiniProgramPage)"],"names":["useUserStore","storeToRefs","ref","uni","wx","request","baseUrl"],"mappings":"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"}