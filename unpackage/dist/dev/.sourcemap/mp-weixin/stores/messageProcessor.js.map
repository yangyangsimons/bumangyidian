{"version":3,"file":"messageProcessor.js","sources":["stores/messageProcessor.js"],"sourcesContent":["// stores/messageProcessor.js\nimport { defineStore } from 'pinia'\nimport { useBarrageStore } from './barrage'\nimport { useAudioPlayerStore } from './audioPlayer'\nimport { ref } from 'vue'\nimport { useSendStore } from './send'\nimport { useIsRadioStore } from './isRadio'\nexport const useMessageProcessorStore = defineStore('messageProcessor', () => {\n  const barrageStore = useBarrageStore()\n  const audioPlayerStore = useAudioPlayerStore()\n  const sendStore = useSendStore()\n  const isRadioStore = useIsRadioStore()\n  // Â§ÑÁêÜÊé•Êî∂Âà∞ÁöÑÊµÅÂºèÊ∂àÊÅØ\n  const isStreaming = ref(false)\n  const accumulatedText = ref('')\n  const lastSectionId = ref(null)\n\n  // Â§ÑÁêÜÊé•Êî∂Âà∞ÁöÑÊ∂àÊÅØ\n  const processMessage = (data) => {\n    // Â¶ÇÊûúÊòØÂ≠óÁ¨¶‰∏≤ÔºåÂÖàÂ∞ùËØïËß£Êûê‰∏∫JSON\n    if (typeof data === 'string') {\n      try {\n        data = JSON.parse(data)\n      } catch (e) {\n        console.error('Ê∂àÊÅØËß£ÊûêÂ§±Ë¥•', e)\n        // ‰Ωú‰∏∫Á∫ØÊñáÊú¨Ê∂àÊÅØÂ§ÑÁêÜ\n        showTextMessage(data)\n        return\n      }\n    }\n\n    // Ê†πÊçÆcmdÁ±ªÂûãÂ§ÑÁêÜ‰∏çÂêåÊ∂àÊÅØ\n    switch (data.cmd) {\n      case 'bg_music':\n        handleBgMusic(data)\n        break\n      case 'audio':\n        handleTtsAudio(data)\n        break\n      case 'finish':\n        handleFinishMessage(data)\n        break\n      case 'subject':\n        handleSubjectRequest(data)\n        break\n      case 'error':\n        handleErrorMessage(data)\n        break\n      default:\n        // Êú™Áü•Ê∂àÊÅØÁ±ªÂûãÔºåÂ∞ùËØï‰Ωú‰∏∫ÊñáÊú¨ÊòæÁ§∫\n        console.warn('Êú™Áü•Ê∂àÊÅØÁ±ªÂûã', data)\n        if (data.text || data.msg) {\n          showTextMessage(data.msg)\n        }\n    }\n  }\n\n  // Â§ÑÁêÜËÉåÊôØÈü≥‰πêÊ∂àÊÅØ\n  const handleBgMusic = (data) => {\n    console.log('Êî∂Âà∞ËÉåÊôØÈü≥‰πêÊ∂àÊÅØ', data)\n    const { audio_url, play_time, section_id, audio_id } = data\n    // Êí≠ÊîæËÉåÊôØÈü≥‰πê\n    audioPlayerStore.playBgMusic(audio_url, play_time, section_id, audio_id)\n    //ËÆæÁΩÆËÉåÊôØÈü≥‰πêÂæ™ÁéØÊí≠Êîæ\n    audioPlayerStore.setBgLoop(true)\n    // ÊòØ‰∏çÊòØÂπøÊí≠Ê®°Âºè\n    if (data.is_radio && data.is_radio == 1) {\n      console.log('ÂΩìÂâçÊòØÂπøÊí≠Ê®°Âºè')\n      isRadioStore.setIsRadio(true)\n      audioPlayerStore.setBgLoop(false) // ËÆæÁΩÆ‰∏∫‰∏çÂæ™ÁéØÊí≠Êîæ\n    }\n    if (data.is_radio && data.lrc) {\n      console.log('ÂΩìÂâçÊòØÂπøÊí≠Ê®°Âºè,Ê≠åËØç:', data.lrc)\n    }\n\n    // ÂèØ‰ª•ÈÄâÊã©ÊòØÂê¶Âú®ÂØπËØùÁïåÈù¢ÊòæÁ§∫Èü≥‰πêÊí≠Êîæ‰ø°ÊÅØ\n    // barrageStore.addMessage({\n    //   type: 'system',\n    //   content: 'üéµ ËÉåÊôØÈü≥‰πêÊí≠Êîæ‰∏≠...',\n    //   showInUI: false, // Â¶ÇÊûú‰∏çÊÉ≥Âú®ÁïåÈù¢ÊòæÁ§∫ÔºåÂèØ‰ª•ËÆæÁΩÆÊ†áËÆ∞\n    // })\n  }\n\n  // Â§ÑÁêÜTTSÈü≥È¢ëÊ∂àÊÅØ\n  const handleTtsAudio = (data) => {\n    console.log('Êî∂Âà∞TTSÈü≥È¢ëÊ∂àÊÅØ', data)\n    if (data.is_radio && data.is_radio == 1) {\n      console.log('ÂΩìÂâçÊòØÂπøÊí≠Ê®°Âºè')\n      isRadioStore.setIsRadio(true)\n    }\n    const { audio_url, section_id, audio_id, text } = data\n    //ËÆæÁΩÆ‰∏∫‰∏çËÉΩÂèëÈÄÅÊ∂àÊÅØ\n    sendStore.setSend(false)\n    // ËÆ∞ÂΩïÂΩìÂâçÂ§ÑÁêÜÁöÑsection_id\n    lastSectionId.value = section_id\n\n    // // Êí≠ÊîæTTSÈü≥È¢ë\n    audioPlayerStore.playTtsAudio(audio_url, section_id, audio_id)\n    if (text) {\n      console.log('Â§ÑÁêÜÊñáÊú¨:')\n\n      // Â¶ÇÊûúÊòØÊñ∞ÁöÑÂØπËØùÊàñÊñ∞ÁöÑsectionÔºåÂºÄÂßãÊñ∞ÁöÑÊµÅÂºèÊ∂àÊÅØ\n      if (!isStreaming.value || lastSectionId.value !== section_id) {\n        console.log('ÂºÄÂßãÊñ∞ÁöÑÊµÅÂºèÊ∂àÊÅØ', {\n          isStreaming: isStreaming.value,\n          lastSectionId: lastSectionId.value,\n          newSectionId: section_id,\n        })\n        isStreaming.value = true\n        accumulatedText.value = ''\n        barrageStore.startNewStreamingMessage()\n      }\n\n      // Á¥ØÁßØÊñáÊú¨\n      accumulatedText.value += text\n\n      // ÂêëÂºπÂπïÊ∑ªÂä†ÊñáÊú¨\n      barrageStore.appendToStreamingMessage(text)\n\n      console.log('ÂΩìÂâçÁ¥ØÁßØÊñáÊú¨:', accumulatedText.value)\n    }\n  }\n\n  // Â§ÑÁêÜÁªìÊùüÊ∂àÊÅØ\n  const handleFinishMessage = (data) => {\n    console.log('Êî∂Âà∞ÁªìÊùüÊ∂àÊÅØ', data)\n    // ËÆæÁΩÆÂèØ‰ª•ÂèëÈÄÅÊ∂àÊÅØ\n    sendStore.setSend(true)\n    const { full_text } = data\n\n    // Â¶ÇÊûúÊúâfull_textÔºåÁî®ÂÆÉÊõøÊç¢Á¥ØÁßØÁöÑÊñáÊú¨\n    if (full_text) {\n      accumulatedText.value = full_text\n    }\n\n    // ÁªìÊùüÊµÅÂºèÊ∂àÊÅØÔºå‰ΩøÁî®Á¥ØÁßØÁöÑÊñáÊú¨Êàñfull_text\n    barrageStore.finishStreamingMessage(full_text || accumulatedText.value)\n\n    // ÈáçÁΩÆÊµÅÂºèÁä∂ÊÄÅ\n    isStreaming.value = false\n    accumulatedText.value = ''\n  }\n\n  // Â§ÑÁêÜ‰∏ªÈ¢òÈÄâÊã©ËØ∑Ê±Ç\n  const handleSubjectRequest = (data) => {\n    console.log('Êî∂Âà∞‰∏ªÈ¢òÈÄâÊã©ËØ∑Ê±Ç', data)\n    const subjects = data.subjects.join('\\n')\n    console.log('ÂèØÈÄâ‰∏ªÈ¢òÂàóË°®', subjects)\n    // ÊòæÁ§∫ÂèØÈÄâ‰∏ªÈ¢òÂàóË°®\n    barrageStore.addMessage({\n      type: 'subject',\n      content: data.msg + '\\n' + subjects,\n    })\n  }\n\n  // Â§ÑÁêÜÈîôËØØÊ∂àÊÅØ\n  const handleErrorMessage = (data) => {\n    console.log('Êî∂Âà∞ÈîôËØØÊ∂àÊÅØ', data)\n    const { text } = data\n\n    // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ\n    uni.showToast({\n      title: text || 'Á≥ªÁªüÈîôËØØ',\n      icon: 'none',\n      duration: 2000,\n    })\n\n    // ÂêåÊó∂Âú®ÂØπËØùÁïåÈù¢ÊòæÁ§∫\n    // barrageStore.addMessage({\n    //   type: 'error',\n    //   content: text || 'Á≥ªÁªüÈîôËØØ',\n    // })\n  }\n\n  // ÈÄöÁî®ÊòæÁ§∫ÊñáÊú¨Ê∂àÊÅØ\n  const showTextMessage = (text, type = 'ai') => {\n    if (!text) return\n\n    barrageStore.addMessage({\n      type: type,\n      content: text,\n    })\n  }\n\n  // Ê∑ªÂä†‰∏Ä‰∏™ÈáçÁΩÆÊñπÊ≥ï\n  const resetProcessor = () => {\n    isStreaming.value = false\n    accumulatedText.value = ''\n    lastSectionId.value = null\n  }\n\n  return {\n    processMessage,\n    resetProcessor, // Êö¥Èú≤Ëøô‰∏™ÊñπÊ≥ï\n    isStreaming, // Â¶ÇÊûúÈúÄË¶ÅÂú®Â§ñÈÉ®ËÆøÈóÆËøô‰∫õÁä∂ÊÄÅÔºå‰πüÂèØ‰ª•Êö¥Èú≤\n    accumulatedText,\n  }\n})\n"],"names":["defineStore","useBarrageStore","useAudioPlayerStore","useSendStore","useIsRadioStore","ref","uni"],"mappings":"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"}